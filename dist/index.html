<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Chat Application</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #messages {
      scroll-behavior: smooth;
    }

    .message-container {
      scrollbar-width: thin;
      scrollbar-color: #06b6d4 #0f172a;
    }
    .message-container::-webkit-scrollbar { width: 6px; }
    .message-container::-webkit-scrollbar-track { 
      background: linear-gradient(to bottom, #0f172a, #1e293b); 
    }
    .message-container::-webkit-scrollbar-thumb {
      background: linear-gradient(45deg, #06b6d4, #8b5cf6);
      border-radius: 3px;
    }
    .glass {
      background: rgba(255, 255, 255, 0.05);
      -webkit-backdrop-filter: blur(20px);
              backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .glass-strong {
      background: rgba(15, 23, 42, 0.8);
      -webkit-backdrop-filter: blur(24px);
              backdrop-filter: blur(24px);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }
    .gradient-bg {
      background: radial-gradient(1400px 700px at 10% 0%, rgba(6,182,212,.12), transparent 65%),
                  radial-gradient(1200px 600px at 90% 0%, rgba(139,92,246,.10), transparent 60%),
                  radial-gradient(800px 400px at 50% 100%, rgba(236,72,153,.08), transparent 50%),
                  linear-gradient(135deg, #0f172a, #1e293b 40%, #0f172a 80%, #1e293b);
    }
    @keyframes slideUp { 
      from { opacity: 0; transform: translateY(12px) scale(0.95); } 
      to { opacity: 1; transform: translateY(0) scale(1); } 
    }
    @keyframes pulse-glow {
      0%, 100% { box-shadow: 0 0 8px rgba(6, 182, 212, 0.3); }
      50% { box-shadow: 0 0 16px rgba(6, 182, 212, 0.5), 0 0 24px rgba(139, 92, 246, 0.2); }
    }
    .fade-in { animation: slideUp .4s cubic-bezier(0.4, 0, 0.2, 1); }
    .message-bubble { animation: slideUp .35s cubic-bezier(0.4, 0, 0.2, 1); }
    .glow-pulse { animation: pulse-glow 2s infinite; }
  </style>

  <script type="module" crossorigin src="/home/assets/index-DvLN-7mu.js"></script>
  <link rel="stylesheet" crossorigin href="/home/assets/index-psQkVc8-.css">
</head>

<body class="gradient-bg min-h-screen">
  <!-- Navbar -->
  <nav class="sticky top-0 z-40 glass-strong shadow-xl">
    <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center gap-8">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center shadow-lg glow-pulse">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
          </div>
          <span class="text-2xl font-bold tracking-wide text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400">ChatApp</span>
        </div>
       
      </div>
      <div id="authArea">
        <button class="bg-gradient-to-r from-cyan-500 to-purple-600 text-white px-6 py-2.5 rounded-xl 
                       hover:from-cyan-600 hover:to-purple-700 transition-all duration-300
                       shadow-lg hover:shadow-xl hover:shadow-cyan-500/25 transform hover:scale-105 font-medium" onclick="  window.location.assign(`http://192.168.1.36:4000` );">
          Logout
        </button>
      </div>
    </div>
  </nav>
<script>


</script>
  <!-- React Mount -->
  <div id="root" class="max-w-25xl mx-auto items-center justify-center min w-full sm:px-2.5 "></div>

  <!-- Chat Overlay -->
  <div id="chat-container" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/60 backdrop-blur-md"></div>

    <div class="relative w-full h-full md:h-[88vh] md:max-w-4xl md:mx-auto md:mt-4 md:rounded-3xl md:overflow-hidden glass-strong shadow-2xl border border-cyan-500/20">
      <!-- Header -->
      <div class="p-6 bg-gradient-to-br from-slate-800/90 via-slate-700/90 to-indigo-900/90 backdrop-blur-xl text-white border-b border-cyan-500/20 shadow-lg">
        <div class="flex items-center justify-between">
          <div class="flex items-center">
            <button id="chatBackBtn" class="mr-4 p-3 rounded-2xl glass hover:bg-white/10 transition-all duration-300 hover:scale-110 group">
              <svg class="h-6 w-6 group-hover:text-cyan-400 transition-colors duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
              </svg>
            </button>
            <div class="flex items-center">
              <div class="relative">
                <div id="chatAvatar" class="w-14 h-14 rounded-2xl bg-gradient-to-br from-cyan-400 to-purple-500 flex items-center justify-center text-white font-bold text-xl mr-5 shadow-xl glow-pulse">
                  U
                </div>
                <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-emerald-400 rounded-full border-3 border-slate-800 shadow-lg animate-pulse"></div>
              </div>
              <div>
                <h2 id="chatUserName" class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white to-cyan-200">Username</h2>
                <p class="text-cyan-200/80 text-sm font-medium flex items-center">
                  <div class="w-2 h-2 bg-emerald-400 rounded-full mr-2 animate-pulse"></div>
                  Active now
                </p>
              </div>
            </div>
          </div>
          <div class="flex items-center space-x-3">
            <button class="p-3 rounded-2xl glass hover:bg-white/10 transition-all duration-300 hover:scale-110 group">
              <svg class="w-5 h-5 group-hover:text-cyan-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
              </svg>
            </button>
            <button class="p-3 rounded-2xl glass hover:bg-white/10 transition-all duration-300 hover:scale-110 group">
              <svg class="w-5 h-5 group-hover:text-cyan-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
              </svg>
            </button>
            <button class="p-3 rounded-2xl glass hover:bg-white/10 transition-all duration-300 hover:scale-110 group">
              <svg class="w-5 h-5 group-hover:text-cyan-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <div id="messages" class="message-container flex-1 p-6 overflow-y-auto space-y-6" style="height: calc(100% - 160px);">
        <div class="text-center py-16">
          <div class="w-20 h-20 mx-auto mb-6 rounded-3xl glass flex items-center justify-center glow-pulse">
            <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
            </svg>
          </div>
          <h3 id="chatWelcomeTitle" class="text-2xl font-bold text-white mb-3">Start the conversation</h3>
          <p id="chatWelcomeSubtitle" class="text-slate-400 text-lg">Send a message to start chatting</p>
        </div>
      </div>

      <!-- Input -->
      <div class="p-6 border-t border-cyan-500/20 glass-strong">
        <div class="flex items-end space-x-4 max-w-4xl mx-auto">
          <button class="p-4 rounded-2xl bg-gradient-to-br from-slate-600 to-slate-700 text-white hover:from-slate-500 hover:to-slate-600 transition-all duration-300 transform hover:scale-110 shadow-lg hover:shadow-xl group">
            <svg class="w-6 h-6 group-hover:text-cyan-400 transition-colors duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"></path>
            </svg>
          </button>
          <div class="flex-1 relative">
            <input
              type="text"
              id="messageInput"
              placeholder="Type your message..."
              class="w-full glass border border-cyan-500/30 rounded-2xl px-6 py-4 pr-14 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-400/50 shadow-lg text-white placeholder-slate-400 transition-all duration-300 text-lg"
            />
            <button class="absolute right-4 top-1/2 -translate-y-1/2 p-2 rounded-xl text-slate-400 hover:text-cyan-400 hover:bg-white/5 transition-all duration-300">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.828 14.828a4 4 0 01-5.656 0M9 10h1m4 0h1m-6-4h8m-9 8v4a1 1 0 001 1h8a1 1 0 001-1v-4m-9-4h10a2 2 0 012 2v6a2 2 0 01-2 2H7a2 2 0 01-2-2v-6a2 2 0 012-2z"></path>
              </svg>
            </button>
          </div>
          <button 
            id="sendBtn"
            class="p-4 rounded-2xl bg-gradient-to-br from-cyan-500 to-purple-600 text-white hover:from-cyan-600 hover:to-purple-700 disabled:opacity-50 disabled:cursor-not-allowed transition-all duration-300 transform hover:scale-110 shadow-lg hover:shadow-xl hover:shadow-cyan-500/30 disabled:transform-none group glow-pulse"
          >
            <svg class="w-6 h-6 group-hover:rotate-45 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Client JS (unchanged features; only fixed tiny path check) -->
  <script>
    // Navbar login display from localStorage (kept)
    const usernameLS = localStorage.getItem("username");
    if (usernameLS) {
      document.getElementById("authArea").innerHTML = `
        <span class="text-slate-200/90">Welcome, <span class="font-semibold text-cyan-300">${usernameLS}</span></span>
      `;
    }

    // Chat state
    let currentUser = '';
    let currentReceiver = '';

    document.addEventListener('DOMContentLoaded', async () => {
      // Session check
      try {
        const sessionRes = await fetch('/session', { credentials: 'include' });
        const sessionData = await sessionRes.json();

        if (sessionData.loggedIn) {
          currentUser = sessionData.username;

          // ✅ open chat if path like /home/:username
          const parts = window.location.pathname.split('/'); // ["", "home", ":username"]
          if (parts.length >= 3 && parts[1] === 'home' && parts[2]) {
            currentReceiver = decodeURIComponent(parts[2]);
            showChatForUser(currentReceiver);
          }
        } else {
          // fallback user (kept)
          currentUser = localStorage.getItem("username") || "Demo User";
        }
      } catch (e) {
        console.error('Session check failed:', e);
        currentUser = localStorage.getItem("username") || "Demo User";
      }

      // Listeners
      document.getElementById('messageInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') sendMessage();
      });
      document.getElementById('sendBtn').addEventListener('click', sendMessage);
      document.getElementById('chatBackBtn').addEventListener('click', () => {
        hideChatContainer();
        window.location.assign(`http://192.168.1.36:4000` );
      });

      // Auto refresh (kept)
      setInterval(() => {
        if (currentReceiver && !document.getElementById('chat-container').classList.contains('hidden')) {
          loadMessages();
        }
      }, 3000);
    });

    // Exposed so React can call on mobile
    window.showChatForUser = function(username) {
      currentReceiver = username;
      document.getElementById('chatUserName').textContent = username;
      document.getElementById('chatAvatar').textContent = username.charAt(0).toUpperCase();
      document.getElementById('chatWelcomeTitle').textContent = `Start chatting with ${username}`;
      document.getElementById('chatWelcomeSubtitle').textContent = `Send a message to ${username}`;
      document.getElementById('chat-container').classList.remove('hidden');
      loadMessages().then(() => {
        // Always scroll to bottom when opening a new chat
        const container = document.getElementById('messages');
        container.scrollTop = container.scrollHeight;
      });
    };

    function hideChatContainer() {
      document.getElementById('chat-container').classList.add('hidden');
      currentReceiver = '';
    }

    async function loadMessages() {
      if (!currentUser || !currentReceiver) return;
      try {
        const res = await fetch(`/api/chat/${encodeURIComponent(currentUser)}/${encodeURIComponent(currentReceiver)}`, { credentials: 'include' });
        const messages = await res.json();

        const container = document.getElementById('messages');
        const wasAtBottom = container.scrollTop >= container.scrollHeight - container.clientHeight - 50;
        
        if (!Array.isArray(messages) || messages.length === 0) {
          container.innerHTML = `
            <div class="text-center py-16">
              <div class="w-20 h-20 mx-auto mb-6 rounded-3xl glass flex items-center justify-center glow-pulse">
                <svg class="w-10 h-10 text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                </svg>
              </div>
              <h3 class="text-2xl font-bold text-white mb-3">Start chatting with ${currentReceiver}</h3>
              <p class="text-slate-400 text-lg">Send a message to begin your conversation</p>
            </div>
          `;
        } else {
          container.innerHTML = '';
          messages.forEach(msg => {
            const isCurrentUser = msg.sender === currentUser;
            const timestamp = new Date(msg.timestamp).toLocaleString();
            const wrapper = document.createElement('div');
            wrapper.className = `message-bubble fade-in flex flex-col ${isCurrentUser ? 'items-end' : 'items-start'} mb-4`;

            wrapper.innerHTML = `
              <div class="text-xs text-slate-400 mb-2 px-3 font-medium">
                ${isCurrentUser ? 'You' : msg.sender} • ${timestamp}
              </div>
              <div class="${isCurrentUser ? 'bg-gradient-to-br from-cyan-500 to-purple-600 text-white shadow-lg shadow-cyan-500/25' : 'glass text-white border border-slate-600/50'} rounded-2xl px-5 py-3 max-w-sm shadow-xl backdrop-blur-xl">
                ${msg.message}
              </div>
            `;
            container.appendChild(wrapper);
          });
        }
        
        // Only auto-scroll if user was already at the bottom
        if (wasAtBottom) {
          container.scrollTop = container.scrollHeight;
        }
      } catch (err) {
        console.error('Error loading messages:', err);
      }
    }

    async function sendMessage() {
      if (!currentUser || !currentReceiver) return;
      const messageInput = document.getElementById('messageInput');
      const message = messageInput.value.trim();
      if (!message) return;

      try {
        const res = await fetch('/api/chat/send', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ receiver: currentReceiver, message })
        });
        if (!res.ok) throw new Error('Failed to send message');
        messageInput.value = '';
        await loadMessages();
      } catch (err) {
        console.error('Error sending message:', err);
        // optimistic add (kept)
        messageInput.value = '';
        const container = document.getElementById('messages');
        const wrapper = document.createElement('div');
        wrapper.className = 'message-bubble flex flex-col items-end mb-4';
        wrapper.innerHTML = `
          <div class="text-xs text-slate-400 mb-2 px-3 font-medium">You • Just now</div>
          <div class="bg-gradient-to-br from-cyan-500 to-purple-600 text-white rounded-2xl px-5 py-3 max-w-sm shadow-xl shadow-cyan-500/25 backdrop-blur-xl">
            ${message}
          </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
      }
    }
  </script>

  <!-- React app -->
</body>
</html>